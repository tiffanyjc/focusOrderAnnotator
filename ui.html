<div id="app">
    <div id="container-labels">
      <div id="order">Order</div>
      <div id="name">Selection Name</div>
      <button id="button-refresh">Tab test</button>

    </div>
    <div id="zero-state">
        <p>
          <span id="add-mini">Annotate</span> your designs. Annotations will auto-update their position, name, and order as you make changes to your designs. 
        </p>
        <p>
          <span id="load-mini">Load</span> an existing layer of annotations to continue making edits. 
        </p>
        <p> 
          <span id="update-mini">Tab test</span> your focus order to see if your current path makes sense.
        </p>
        <p>
          <span id="annotation-mini">!</span> This plugin uses metadata to link annotations to nodes, so loading manually-created annotation layers is not allowed. 
        </p>
    </div>
    <button id="button-load">Load annotations layer</button>
    <button id="button-add">Annotate selection(s)</button>
    
</div>

<script>
var exports = {}; 
var totalFocus = 0; 
var focusedIDs = []; 
var curTabID = ""; 

// instructions when pane is empty
function checkZeroState() {
  var divs = document.getElementsByClassName("focus-object"); 
  document.getElementById("zero-state").hidden = (divs.length > 0); 
  document.getElementById("button-load").hidden = (divs.length > 0); 
  document.getElementById("order").innerHTML = (divs.length > 0) ? "Order" : ""; 
  document.getElementById("name").innerHTML = (divs.length > 0) ? "Name" : ""; 
  document.getElementById("container-labels").style.visibility = (divs.length <= 0) ? "hidden" : "visible"; 
  document.getElementById("button-refresh").hidden = (divs.length <= 0); 
  document.getElementById("button-add").style.width = (divs.length > 0) ? "calc(100% - 25px)" : "calc((100% - 25px)/2)" ;
}


// styling for affordances on drag over
function dragOver(ev) {
  ev.preventDefault();
  var topY = ev.currentTarget.getBoundingClientRect().top; 
  var bottomY = ev.currentTarget.getBoundingClientRect().bottom; 
  var midY = (topY + bottomY) / 2; 
  var hoverPoint = ev.clientY < midY; 

  ev.currentTarget.style.borderTopColor = hoverPoint ? "#1DA0FB" : "#FFFFFF"; 
  ev.currentTarget.style.borderTopWidth = hoverPoint ? "3px" : "1px"; 
  ev.currentTarget.style.borderBottomColor = hoverPoint ? "#EFEFEF" : "#1DA0FB"; 
  ev.currentTarget.style.borderBottomWidth = hoverPoint ? "1px" : "3px"; 
}

// determine where focus annotation gets dropped
function drop(ev) {
  ev.preventDefault(); 
  var data = ev.dataTransfer.getData("text");
  var toDrop = document.getElementById(data); 
  var topY = ev.currentTarget.getBoundingClientRect().top; 
  var bottomY = ev.currentTarget.getBoundingClientRect().bottom; 
  var midY = (topY + bottomY) / 2; 
  var hoverPoint = ev.clientY < midY; 
  
  (document.getElementById("app")).insertBefore(toDrop, (hoverPoint) ? ev.currentTarget : ev.currentTarget.nextSibling); 

  toDrop.style.borderTopColor = "#FFFFFF"; 
  ev.currentTarget.style.borderTopColor = "#FFFFFF"; 
  ev.currentTarget.style.borderTopWidth = "1px"; 
  toDrop.style.borderBottomColor = "#EFEFEF"; 
  ev.currentTarget.style.borderBottomColor = "#EFEFEF"; 
  ev.currentTarget.style.borderBottomWidth = "1px"; 

  resort(); 
}

function dragStart(ev) {
  ev.dataTransfer.setData("text", ev.target.id); 
}

// styling reset
function dragLeave(ev) {
  ev.preventDefault(); 
  var curTarget = ev.currentTarget; 
  curTarget.style.borderTopColor = "#FFFFFF"; 
  curTarget.style.borderTopWidth = "1px"; 
  curTarget.style.borderBottomColor = "#EFEFEF"; 
  curTarget.style.borderBottomWidth = "1px"; 
}

// resort when objects are removed, moved, or added 
function resort() {
  focusedIDs = []; 
  var focusObjects = document.getElementsByClassName("focus-object"); 
  var focusOrder = 1; 

  // iterate through all objects 
  for (let obj of focusObjects) {
    var objElements = obj.getElementsByTagName("div"); 
    focusedIDs.push(obj.id); 

    // iterate through div tags
    for (let div of objElements) {
      if (div.className == "order") {
        var prevNumber = div.innerHTML; 
        div.innerHTML = focusOrder; 
        reannotateFocus(obj.id, prevNumber, focusOrder); 
        focusOrder += 1; 
      }
    }
  }
}

// remove an item from the focus list 
function removeFocusUI(ID) {
  focusedIDs = focusedIDs.filter((id) => {return id != ID}); 
  document.getElementById(ID).remove(); 
  totalFocus -= 1;
  removeFocusAnnotation(ID); 
  checkZeroState(); 
  resort(); 
}

function createFocusUI(selectionName, selectionID, loading) {
  // you can only add a node once 
  if (focusedIDs.includes(selectionID)) {
    return; 
  }

  focusedIDs.push(selectionID); 

  // create the new object 
  var newFocus = document.createElement("div"); 
  newFocus.className = "focus-object"; 
  newFocus.id = selectionID; 
  newFocus.draggable = true; 
  newFocus.ondragstart = () => {dragStart(event)}; 
  newFocus.ondragleave = () => {dragLeave(event)}; 
  newFocus.ondragover = () => {dragOver(event)}; 
  newFocus.ondrop = () => {drop(event)}; 
  newFocus.onclick = () => {showFocus(selectionID)}; 
  newFocus.onfocus = () => {showFocus(selectionID)}; 

  // create order number
  var orderNumber = document.createElement("div"); 
  orderNumber.className = "order";
  orderNumber.innerHTML = totalFocus + 1; 
  
  // create name
  var name = document.createElement("div"); 
  name.className = "name"; 
  name.innerHTML = selectionName; 
  
  // create remove button
  var removeButton = document.createElement("button"); 
  removeButton.className = "button-remove"; 
  removeButton.innerHTML = "Remove"; 
  removeButton.onclick = () => { removeFocusUI(selectionID) }; 

  // create tab-help button 
  var tabContainer = document.createElement("div"); 
  tabContainer.id = "tab-help"; 
  tabContainer.innerHTML = "<div id='tab-help'> &#8593; <span class='keyboard-mini'>Shift</span> <span class='keyboard-mini'>Tab</span> <br /> &darr; <span class='keyboard-mini'>Tab</span> </div> "; 
  
  // add everything into the larger div
  newFocus.appendChild(orderNumber);  
  newFocus.appendChild(name);
  newFocus.appendChild(removeButton);  
  newFocus.appendChild(tabContainer); 
  
  // add larger div into the plugin pane, annotate and check for zero state 
  document.getElementById('app').appendChild(newFocus); 
  if (!loading) {annotateFocus(selectionID, totalFocus+1); }; 
  showFocus(selectionID); 
  checkZeroState(); 
  totalFocus += 1; 
}

//////////////////////////////
////// calls to parent //////
//////////////////////////////

function annotateFocus(selectionID, orderNumber) {
  parent.postMessage({ pluginMessage: {type: 'create-annotationUI', id: selectionID, number: orderNumber}}, '*'); 
}

function reannotateFocus(selectionID, prevOrderNumber, nextOrderNumber) {
  parent.postMessage({ pluginMessage: {type: 'renumber-annotationUI', id: selectionID, prevNumber: prevOrderNumber, nextNumber: nextOrderNumber}}, '*'); 
}

function removeFocusAnnotation(selectionID) {
  parent.postMessage({ pluginMessage: {type: 'remove-annotationUI', id: selectionID}}, '*'); 
}


function showFocus(selectionID) {
  // revert previous selected tab
  var curTab = document.getElementById(curTabID); 
  if (curTab != null) {
    curTab.className = "focus-object"; 
  }

  var selected = document.getElementById(selectionID); 
  if (selected != null) {
    var classNew = selected.className.concat(" tab-on"); 
    document.getElementById(selectionID).className = classNew; 
    curTabID = selectionID; 
    parent.postMessage({ pluginMessage: {type: 'select-annotationUI', id: selectionID}}, '*'); 
  }
}


// initiatialization 
document.getElementById("order").innerHTML = ""; 
document.getElementById("name").innerHTML = ""; 
document.getElementById("container-labels").style.visibility = "hidden";  
document.getElementById('button-refresh').hidden = true;
document.getElementById('button-add').onclick = () => {
  parent.postMessage({ pluginMessage: {type: 'add-focus'}}, '*'); 
}
document.getElementById('button-load').onclick = () => {
  parent.postMessage({ pluginMessage: {type: 'load-annotations'}}, '*'); 
}

document.getElementById('button-refresh').onclick = () => {

  if (focusedIDs.length > 0) {
    var buttonRefresh = document.getElementById('button-refresh'); 
    var removeButtons = document.getElementsByClassName('button-remove'); 
    var foci = document.getElementsByClassName('focus-object'); 
    switch (buttonRefresh.innerHTML) {
      case "Tab test":
        parent.postMessage({ pluginMessage: {type: 'test-annotationUI'}}, '*'); 
        buttonRefresh.innerHTML = "Exit test"; 
        buttonRefresh.className = "button-refresh-exit"; 
        document.getElementById('button-add').hidden = true; 
        for (let b of removeButtons) {b.hidden = true;}; 
        var i = 1; 
        for (let f of foci) {
          f.tabIndex = i; 
          f.className = "focus-object"; 
          if (i == 1) {
            f.focus(); 
          }
          i++; 
        }
        break; 
      case "Exit test": 
        buttonRefresh.innerHTML = "Tab test"; 
        buttonRefresh.className = ""; 
        document.getElementById('button-add').hidden = false; 
        for (let b of removeButtons) {b.hidden = false;}
        for (let f of foci) {
          f.removeAttribute("tabIndex"); 
          f.className = "focus-object"; 
        }
        break; 
    }
  }; 

}

if (!document.hasFocus()) { 
  parent.postMessage({ pluginMessage: { type: 'window-blur' } }, '*');
  for (let selectionID of focusedIDs) {
    parent.postMessage({ pluginMessage: {type: 'refresh-annotationUI', id: selectionID}}, '*'); 
  }
}

window.addEventListener('focus', () => {
  parent.postMessage({ pluginMessage: { type: 'window-focus' } }, '*');
  for (let selectionID of focusedIDs) {
    parent.postMessage({ pluginMessage: {type: 'refresh-annotationUI', id: selectionID}}, '*'); 
  }
});

window.addEventListener('blur', () => {
  parent.postMessage({ pluginMessage: { type: 'window-blur' } }, '*');
});

//////////////////////////////////
////// messages from parent //////
//////////////////////////////////

onmessage = (event) => {
  var message = event.data.pluginMessage; 
  if (message.type === 'add-focus') {
    var names = message.names; 
    var ids = message.ids; 

    while (names.length > 0) {
      var name = names.shift(); 
      var id = ids.shift(); 
      createFocusUI(name, id, message.loading); 
    } 
  } else if (message.type === 'node-rename') {
    var divs = document.getElementById(message.id).getElementsByTagName("div"); 

    for (let div of divs) {
      if (div.className == "name") {
        div.innerHTML = message.nodeName; 
      }
    }
  } else if (message.type === 'node-remove') {
    removeFocusUI(message.id); 
  } else if (message.type === 'update-buttons') {
    document.getElementById('button-add').disabled = message.isDisabled; 
    document.getElementById('button-load').disabled = message.isDisabled; 
  }
}


</script>
<style>
  #app {
    width: 100%; 
    position: absolute; 
    top: 0px; 
    left: 0px; 
    padding-bottom: 50px; 
    font-family: "Segoe UI"; 
    font-size: 12px; 
  }

  #container-header {
      background-color: #222222; 
      padding: 10px 0px; 
      color: white; 
      text-transform: 'uppercase'; 
      text-align: center; 
      font-weight: 500; 
  }

  #container-labels {
    position: sticky; 
    top: 0; 
    background-color: white; 
    padding: 10px 15px; 
    /* margin: 0px 15px;  */
    border-bottom: 1px solid #EFEFEF; 
    display: grid; 
    grid-template-columns: 20px 60px auto 70px; 
    color: #2C2C2C; 
    font-weight: bold;  
  }

  #order, #name {
    display: flex; 
    flex-direction: row; 
    align-items: center; 
  }


  #order {
    grid-column-start: 1; 
  }
  #name {
    grid-column-start: 3; 
  }

  #tab-help {
    grid-column-start: 4; 
    width: 80px; 
    line-height: 20px; 
    display: none; 
    
  }

  .keyboard-mini {
    padding: 1px 3px 2px 3px; 
    border-radius: 4px; 
    background-color: #D5D5D5; 
    color: 2C2C2C; 
    font-weight: 300; 
    font-size: 10px; 
  }

 /* ///////////////////////// */
  /* // ZERO STATE STYLING ////*/
  /* ///////////////////////// */

  #zero-state {
    line-height: 19px; 
    padding: 35px 50px; 
  }

  #zero-state p {
    padding-bottom: 8px; 
    border-bottom: 1px solid #E4E3E3; 
  }
  #zero-state p:nth-child(4) {
    border-bottom: none; 
  }

  #add-mini {
    padding: 2px 10px 3px 10px; 
    border-radius: 4px; 
    background-color: #1DA0FB; 
    color: white; 
    margin-right: 3px; 
  }

  #load-mini {
    padding: 2px 7px 3px 7px; 
    border-radius: 4px; 
    color: #1DA0FB; 
    background-color: white; 
    border: 1px solid #1DA0FB; 
    margin-right: 3px; 
  }

  #update-mini {
    background-color: #2C2C2C; 
    padding: 2px 10px 3px 10px; 
    border-radius: 4px; 
    color: white; 
    margin-right: 3px; 
  }

  #annotation-mini {
    padding: 2px 9px 3px 9px; 
    border-radius: 4px; 
    background-color: #F36969; 
    color: white; 
    margin-right: 3px; 
  }
   /* //////////////////////////////// */
  /* // ANNOTATION OBJECT STYLING ////*/
  /* //////////////////////////////// */


  .focus-object {
    padding: 10px 0px; 
    margin: 0px 15px; 
    border-bottom: 1px solid #EFEFEF; 
    border-top: 1px solid #ffffff; 
    font-weight: normal; 
    display: grid; 
    grid-template-columns: 20px 60px auto 70px; 
  }

  .focus-object:focus {
    padding: 10px 15px; 
    margin: 0px; 
    outline: none; 
    color: #2c2c2c; 
    border: 2px solid #1DA0FB; 
    border-top: 2px solid #1DA0FB; 
  }


.focus-object:focus #tab-help {
  display: block; 
}

  .focus-object:hover {
    cursor: move; 
  }

  .tab-on {
     font-weight: bold; 
  }

  .move-icon {
    width: 20px; 
    grid-column-start: 1; 
    max-height: 36px; 
  
    display: flex; 
    flex-direction: row;
    flex-wrap: wrap; 
    justify-content: space-between; 
  }

  .move-icon:hover {
    cursor: move; 
  }
  
  .move-icon-dot {
    width: 4px; 
    height: 4px; 
    margin: 3px;
    border-radius: 300px; 
    background-color: #C4C4C4; 
  }

  .order, .name {
    display: flex; 
    flex-direction: row; 
    align-items: center; 
  }

  .order {
    grid-column-start: 1; 
  }

  .name {
    grid-column-start: 3; 
  }

  /* /////////////////////// */
  /* // BUTTON STYLING ////*/
  /* /////////////////////// */


  #button-refresh:focus, #button-add:focus, #button-load:focus, .button-remove:focus {
    border: 3px solid "red"; 
  }

  #button-refresh, #button-add, #button-load,#button-refresh:disabled:hover, .button-remove {
    color: white; 
    font-weight: 400; 
    border-radius: 10px; 
    box-shadow: none; 
    cursor: pointer; 
    border: 1px solid white; 
    height: 30px; 
  }

  #button-refresh:disabled:hover, #button-add:disabled:hover, #button-load:disabled:hover {
    cursor: default; 
  }

  #button-add:disabled, #button-add:disabled:hover{
    background-color: #929292;  
    border:1px solid white; 
  }

  #button-load:disabled, #button-load:disabled:hover {
    border-color: #929292; 
    color: #929292; 
  }

  #button-back {
    grid-column-start: 1; 
    padding-left: 5px; 
    background-color: #2C2C2C; 
    color: white; 
    border: 1px solid white; 
    font-weight: 500; 
    border-radius: 999px; 
    margin: 2px 2px 1px 2px; 
    width: 21px; 
  }


  #button-load {
    grid-column-start: 1; 
    margin: 10px; 
    height: 35px; 
    width:calc((100% - 25px)/2); 
    position: fixed; 
    bottom: 0px; 
    right: 0px; 
    background-color: white; 
    color: #1DA0FB; 
    border: 1px solid #1DA0FB; 
  }
  #button-add {
    grid-column-start: 1; 
    margin: 10px; 
    height: 35px; 
    width:calc((100% - 25px)/2); 
    position: fixed; 
    bottom: 0px; 
  }
  #button-add{
    background-color: #1DA0FB; 
  }
  .button-refresh-exit {
    background-color: #F36969 !important; 
    border: 1px solid #F36969 !important; 
  }

  #button-refresh, #button-refresh:disabled:hover {
    grid-column-start: 4; 
    background-color: #2C2C2C; 
    margin: 2px 2px 1px 2px; 
  }

  #button-refresh:disabled {
    opacity: .45; 
  }

  #button-refresh:hover, #button-back:hover {
    color: #2C2C2C; 
    border-color: #2C2C2C; 
    background-color: white; 
    outline: none; 
    cursor: pointer; 
  }

  .button-remove {
    grid-column-start: 4; 
    background-color: #F36969; 
    border: 1px solid #F36969; 
  }
  #button-load:hover {
    color: #1DA0FB; 
    border: 1px solid #1DA0FB; 
  }
  #button-add:hover {
    background-color: #1DA0FB; 
    border-color: #1DA0FB; 
    outline: none; 
  }

  .button-refresh-exit:hover, .button-remove:hover {
    background-color: #E45353 !important; 
    border-color: #E45353 !important; 
    color: white !important; 
  }

</style>